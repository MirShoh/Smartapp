<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kosmik Sayohat Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #1a0b2e; /* Zaxira fon rangi */
            font-family: 'Nunito', sans-serif; 
            user-select: none; 
        }
        
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI Qatlami */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Kamera Oynasi */
        #video-container {
            position: absolute; bottom: 20px; right: 20px; 
            width: 120px; height: 90px;
            border-radius: 15px; border: 3px solid #00ffcc; z-index: 5; 
            background: #000; overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.4);
        }
        #video-preview {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* Oyna effekti */
        }

        h1 { 
            font-family: 'Fredoka One', cursive; font-size: 2.5rem; 
            color: #fff; text-shadow: 0 4px 0 #6a0dad; margin-top: 20px;
            background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        .level-badge {
            background: #ffaa00; color: #fff; padding: 5px 15px; 
            border-radius: 15px; font-weight: bold; margin-bottom: 10px;
            box-shadow: 0 3px 0 #cc8800;
        }

        #gesture-hint {
            margin-top: 20px;
            background: rgba(0,0,0,0.8); color: #00ffcc;
            padding: 10px 30px; border-radius: 50px;
            font-size: 1.4rem; font-weight: bold; border: 2px solid #00ffcc;
            transition: all 0.3s ease; opacity: 0; transform: translateY(20px);
        }
        #gesture-hint.visible { opacity: 1; transform: translateY(0); }

        /* Overlay Ekranlar */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 10, 40, 0.95); z-index: 50; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #00ccff, #0066ff); border: none; padding: 18px 50px;
            color: white; font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin-top: 30px;
            box-shadow: 0 10px 0 #0044cc, 0 10px 20px rgba(0,0,0,0.4); 
            font-family: 'Fredoka One', cursive; pointer-events: auto;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(5px); box-shadow: 0 5px 0 #0044cc; }
        .btn:disabled { background: #555; box-shadow: none; color: #999; cursor: not-allowed; }

        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #fff;
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <!-- Boshlash Ekrani -->
    <div id="start-screen" class="overlay-screen">
        <h1 style="font-size: 3.5rem; margin-bottom: 10px;">KOSMIK SAYOHAT</h1>
        <p style="font-size: 1.2rem; max-width: 400px; color: #aaa;">Qo'lingiz bilan buyumlarni ushlang va joyiga qo'ying.</p>
        
        <div id="loading-container">
            <div class="loading-spinner"></div>
            <div id="loading-text">Kamera va AI yuklanmoqda...</div>
        </div>
        
        <button id="start-btn" class="btn hidden">BOSHLASH üöÄ</button>
    </div>

    <!-- O'yin UI -->
    <div id="ui-layer" class="hidden">
        <div class="level-badge" id="level-display">1-BOSQICH</div>
        <h1 id="task-title" style="font-size: 2rem; margin-top: 0;">SAYYORALAR</h1>
        <div id="gesture-hint">‚úä USHLANG!</div>
    </div>
    
    <!-- Yutish Ekrani -->
    <div id="win-screen" class="overlay-screen hidden">
        <h1 style="font-size: 4rem; color: #FFD700;">G'ALABA! üéâ</h1>
        <p style="font-size: 1.5rem;">Siz uddaladingiz!</p>
        <button id="next-level-btn" class="btn">DAVOM ETISH ‚û°Ô∏è</button>
    </div>

    <!-- Kamera va Canvas -->
    <div id="video-container">
        <canvas id="video-preview"></canvas>
    </div>
    <video id="input-video" playsinline webkit-playsinline muted autoplay style="display:none"></video>
    <div id="canvas-container"></div>

<script>
    // --- KONFIGURATSIYA ---
    const CONFIG = {
        sensitivityX: 2.2, // Gorizontal sezgirlik
        sensitivityY: 1.8, // Vertikal sezgirlik
        snapDistance: 1.8, // Ushlash masofasi (Kattalashtirildi - osonroq bo'lishi uchun)
        cursorSize: 0.4
    };

    const LEVELS = [
        { title: "SHAKLLAR", items: ["‚≠ê", "‚ù§Ô∏è", "üü¶", "üî∫"], color: 0xFFD700 },
        { title: "MEVALAR", items: ["üçé", "üçå", "üçá", "üçâ"], color: 0xFF4500 },
        { title: "KOSMOS", items: ["üåç", "üöÄ", "üõ∏", "ü™ê"], color: 0x00BFFF }
    ];

    const state = {
        levelIdx: 0,
        handPos: { x: 0, y: 0 },
        handVisible: false,
        gesture: 'OPEN', // OPEN yoki PINCH
        grabbedObj: null,
        hoveredObj: null,
        lockedCount: 0,
        isLevelComplete: false
    };

    // --- DOM ELEMENTLARI ---
    const ui = {
        startScreen: document.getElementById('start-screen'),
        winScreen: document.getElementById('win-screen'),
        uiLayer: document.getElementById('ui-layer'),
        startBtn: document.getElementById('start-btn'),
        nextBtn: document.getElementById('next-level-btn'),
        loading: document.getElementById('loading-container'),
        hint: document.getElementById('gesture-hint'),
        title: document.getElementById('task-title'),
        level: document.getElementById('level-display'),
        video: document.getElementById('input-video'),
        preview: document.getElementById('video-preview')
    };
    
    const previewCtx = ui.preview.getContext('2d');

    // --- 1. SETUP THREE.JS (Grafika) ---
    const scene = new THREE.Scene();
    // TUZATISH 1: Fon rangini CSS dan emas, Three.js dan beramiz.
    scene.background = new THREE.Color(0x1a0b2e); 
    scene.fog = new THREE.FogExp2(0x1a0b2e, 0.035); // Tuman ham fon rangida bo'lishi shart

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.z = 12;

    const renderer = new THREE.WebGLRenderer({ antialias: true }); // alpha: true O'CHIRILDI (Oq fon muammosini hal qiladi)
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // Yoritish
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(5, 10, 7);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // Yulduzlar
    const starsGeo = new THREE.BufferGeometry();
    const starCount = 800;
    const posArray = new Float32Array(starCount * 3);
    for(let i=0; i<starCount*3; i++) posArray[i] = (Math.random() - 0.5) * 60;
    starsGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    const starsMat = new THREE.PointsMaterial({color: 0xffffff, size: 0.15});
    const stars = new THREE.Points(starsGeo, starsMat);
    scene.add(stars);

    // Ob'ektlar guruhi
    const piecesGroup = new THREE.Group();
    const ghostGroup = new THREE.Group();
    scene.add(piecesGroup);
    scene.add(ghostGroup);

    // Kursor
    const cursor = new THREE.Mesh(
        new THREE.RingGeometry(0.3, 0.45, 32),
        new THREE.MeshBasicMaterial({ color: 0xFFFF00, transparent: true, opacity: 0.8 })
    );
    scene.add(cursor);

    // --- 2. TEXTURE YARATISH (Tuzatilgan) ---
    function createTexture(text, isGhost, colorHex) {
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 256;
        const ctx = canvas.getContext('2d');
        
        // TUZATISH 2: Emojilar to'g'ri chiqishi uchun fontlar ketma-ketligi
        ctx.font = 'bold 130px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const mainColor = '#' + new THREE.Color(colorHex).getHexString();

        if (isGhost) {
            // Joyi (Ramka)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 6;
            ctx.setLineDash([15, 10]);
            ctx.beginPath();
            ctx.arc(128, 128, 110, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.fillText(text, 128, 138);
        } else {
            // Ob'ekt (Tanga ko'rinishida fon bilan)
            ctx.beginPath();
            ctx.arc(128, 128, 120, 0, Math.PI * 2);
            ctx.fillStyle = mainColor;
            ctx.fill();
            
            // Yaltiroq effekt
            const grad = ctx.createLinearGradient(0, 0, 256, 256);
            grad.addColorStop(0, 'rgba(255,255,255,0.4)');
            grad.addColorStop(1, 'rgba(0,0,0,0.1)');
            ctx.fillStyle = grad;
            ctx.fill();

            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 10;
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.fillText(text, 128, 138);
        }

        const tex = new THREE.CanvasTexture(canvas);
        tex.needsUpdate = true; // Texture yangilanishi shart
        return tex;
    }

    // --- 3. LEVEL LOGIKASI ---
    function initLevel(idx) {
        // Tozalash
        while(piecesGroup.children.length) { piecesGroup.remove(piecesGroup.children[0]); }
        while(ghostGroup.children.length) { ghostGroup.remove(ghostGroup.children[0]); }
        
        state.levelIdx = idx;
        const lvl = LEVELS[idx];
        state.lockedCount = 0;
        state.isLevelComplete = false;
        
        ui.title.innerText = lvl.title;
        ui.level.innerText = (idx + 1) + "-BOSQICH";

        const count = lvl.items.length;
        const radius = window.innerWidth < 600 ? 2.5 : 3.5;
        const angleStep = (Math.PI * 2) / count;

        lvl.items.forEach((item, i) => {
            let angle = i * angleStep - Math.PI/2;
            const targetPos = new THREE.Vector3(Math.cos(angle)*radius, Math.sin(angle)*radius, 0);

            // TUZATISH 3: Sfera o'rniga "Cylinder" (Tanga) ishlatamiz.
            // Bu teksturani cho'zilib ketishini oldini oladi.
            
            // 1. Ghost (Joyi)
            const ghostTex = createTexture(item, true, lvl.color);
            const ghostMat = new THREE.MeshBasicMaterial({ map: ghostTex, transparent: true });
            const ghost = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), ghostMat); // Yassi
            ghost.position.copy(targetPos);
            ghost.position.z = -0.1;
            ghostGroup.add(ghost);

            // 2. Ob'ekt (O'ynaladigan)
            const pieceTex = createTexture(item, false, lvl.color);
            const pieceMat = new THREE.MeshStandardMaterial({ map: pieceTex, roughness: 0.3, metalness: 0.1 });
            // Tanga shakli: CylinderGeometry(radiusTop, radiusBottom, height, segments)
            const piece = new THREE.Mesh(new THREE.CylinderGeometry(0.9, 0.9, 0.1, 32), pieceMat);
            
            // Tangani kameraga qaratish
            piece.rotation.x = Math.PI / 2; 

            // Tasodifiy joylashuv
            piece.position.set((Math.random()-0.5)*5, (Math.random()-0.5)*4, 1);
            
            piece.userData = { id: i, targetPos: targetPos, isLocked: false };
            piecesGroup.add(piece);
        });
    }

    // --- 4. MEDIA PIPE & AI (Tuzatilgan) ---
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    
    // TUZATISH 4: Model murakkabligini oshiramiz (0 dan 1 ga) va ishonchni pasaytirib, sezgirlikni oshiramiz.
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1, // Aniqlikni oshiradi
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    // KAmerani ishga tushirish
    async function startCamera() {
        ui.startBtn.innerText = "Kamera yoqilmoqda...";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" }
            });
            ui.video.srcObject = stream;
            ui.video.onloadedmetadata = () => {
                ui.video.play();
                ui.startScreen.classList.add('hidden');
                ui.uiLayer.classList.remove('hidden');
                initLevel(0);
                requestAnimationFrame(loop);
            };
        } catch(err) {
            alert("Kamera xatosi: " + err.name);
            ui.startBtn.innerText = "Xatolik!";
        }
    }

    function onResults(results) {
        // Preview chizish
        ui.preview.width = ui.video.videoWidth;
        ui.preview.height = ui.video.videoHeight;
        previewCtx.clearRect(0,0, ui.preview.width, ui.preview.height);
        previewCtx.drawImage(results.image, 0, 0, ui.preview.width, ui.preview.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            
            // TUZATISH 5: Koordinatalarni barqarorlashtirish
            const x = lm[9].x; // O'rta barmoq asosi (barqarorroq)
            const y = lm[9].y;

            // Oyna effekti va ekran nisbati
            state.handPos.x = -(x - 0.5) * CONFIG.sensitivityX * 2; 
            state.handPos.y = -(y - 0.5) * CONFIG.sensitivityY * 1.5;
            state.handVisible = true;

            // Gesture (Chimchilash)
            const thumb = lm[4];
            const index = lm[8];
            const dist = Math.hypot(thumb.x - index.x, thumb.y - index.y);
            
            if (dist < 0.08) state.gesture = 'PINCH'; // Osonroq ushlash uchun 0.08
            else state.gesture = 'OPEN';

        } else {
            state.handVisible = false;
        }
    }

    async function loop() {
        if(!ui.video.paused && !ui.video.ended) {
            await hands.send({image: ui.video});
        }
        
        // --- O'yin Loop ---
        updateGame();
        renderer.render(scene, camera);
        requestAnimationFrame(loop);
    }

    // --- 5. O'YIN MANTIQI ---
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let hintTimeout;

    function updateGame() {
        // Yulduzlar aylanishi
        stars.rotation.y += 0.001;

        // Kursor harakati (Smooth)
        mouse.x += (state.handPos.x - mouse.x) * 0.2;
        mouse.y += (state.handPos.y - mouse.y) * 0.2;

        if(state.handVisible) {
            raycaster.setFromCamera(mouse, camera);
            // Z=0 tekisligidagi nuqtani topish
            const dist = -camera.position.z / raycaster.ray.direction.z;
            const worldPos = raycaster.ray.origin.clone().add(raycaster.ray.direction.clone().multiplyScalar(dist));
            
            cursor.position.copy(worldPos);
            cursor.visible = true;

            // Kursor rangi va o'lchami
            if(state.gesture === 'PINCH') {
                cursor.scale.setScalar(0.8);
                cursor.material.color.setHex(0x00FF00); // Yashil
                ui.hint.classList.add('visible');
                ui.hint.innerText = "USHLADINGIZ!";
                ui.hint.style.color = "#00FF00";
                ui.hint.style.borderColor = "#00FF00";
            } else {
                cursor.scale.setScalar(1.2);
                cursor.material.color.setHex(0xFFFF00); // Sariq
                
                // Agar hech narsa ushlamagan bo'lsa
                if(state.hoveredObj) {
                    ui.hint.classList.add('visible');
                    ui.hint.innerText = "‚úä MUSHT QILING";
                    ui.hint.style.color = "#FFFF00";
                    ui.hint.style.borderColor = "#FFFF00";
                } else {
                    ui.hint.classList.remove('visible');
                }
            }

            // Raycasting (To'qnashuv)
            const intersects = raycaster.intersectObjects(piecesGroup.children);
            
            // 1. Hover (Ustiga kelish)
            if(intersects.length > 0 && !state.grabbedObj) {
                const obj = intersects[0].object;
                if(!obj.userData.isLocked) {
                    state.hoveredObj = obj;
                    obj.scale.setScalar(1.2);
                }
            } else {
                if(state.hoveredObj && state.hoveredObj !== state.grabbedObj) {
                    state.hoveredObj.scale.setScalar(1);
                    state.hoveredObj = null;
                }
            }

            // 2. Grab (Ushlash)
            if(state.gesture === 'PINCH') {
                if(!state.grabbedObj && state.hoveredObj) {
                    state.grabbedObj = state.hoveredObj;
                }
            } else {
                // 3. Drop (Qo'yib yuborish)
                if(state.grabbedObj) {
                    const p = state.grabbedObj;
                    const dist = p.position.distanceTo(p.userData.targetPos);
                    
                    if(dist < CONFIG.snapDistance) {
                        // Joyiga tushdi!
                        p.position.copy(p.userData.targetPos);
                        p.rotation.set(0, 0, 0); // Yassi bo'lib qoladi
                        p.userData.isLocked = true;
                        p.material.emissive.setHex(0x00ff00);
                        
                        state.lockedCount++;
                        if(state.lockedCount === state.totalPieces) {
                            setTimeout(() => {
                                ui.winScreen.classList.remove('hidden');
                                ui.uiLayer.classList.add('hidden');
                            }, 500);
                        }
                    } else {
                        // Joyiga tushmadi
                        p.scale.setScalar(1);
                    }
                    state.grabbedObj = null;
                }
            }

            // Obyekt harakati (Agar ushlangan bo'lsa)
            if(state.grabbedObj) {
                state.grabbedObj.position.lerp(worldPos, 0.3);
                state.grabbedObj.position.z = 1; // Oldinga chiqadi
                state.grabbedObj.rotation.x = Math.PI / 2; // Tanga holatini saqlash
            }

        } else {
            cursor.visible = false;
        }
    }

    // --- EVENT LISTENERS ---
    hands.initialize().then(() => {
        ui.loading.style.display = 'none';
        ui.startBtn.classList.remove('hidden');
    });

    ui.startBtn.addEventListener('click', startCamera);
    
    ui.nextBtn.addEventListener('click', () => {
        ui.winScreen.classList.add('hidden');
        ui.uiLayer.classList.remove('hidden');
        
        state.levelIdx++;
        if(state.levelIdx >= LEVELS.length) state.levelIdx = 0;
        initLevel(state.levelIdx);
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>