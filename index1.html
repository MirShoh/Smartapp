<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Bolajon - Kamera Boshqaruvi</title>
    <!-- React va ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Handtrack.js (Qo'l harakatini aniqlash uchun) -->
    <script src="https://cdn.jsdelivr.net/npm/handtrackjs/dist/handtrack.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            overflow: hidden; /* Scroll bo'lmasligi uchun */
        }
        .game-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .game-card:active {
            transform: scale(0.95);
        }
        .game-card.hover-active { /* Kamera orqali ustiga kelganda */
            transform: scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 4px solid #FCD34D; /* Sariq hoshiya */
        }
        .bounce {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 100;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* Virtual Kursor Stillari */
        #virtual-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            background-color: rgba(255, 0, 0, 0.5);
            pointer-events: none; /* Kursor elementlarni to'sib qo'ymasligi uchun */
            z-index: 9999;
            transform: translate(-50%, -50%);
            display: none;
            transition: background-color 0.2s;
        }
        #cursor-progress {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #FFD700;
            transition: transform 0.1s linear;
            display: none;
        }
        .loading-cursor #cursor-progress {
            display: block;
            animation: spin 1.5s linear infinite; /* Fallback animation */
        }
        
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Virtual Kursor Elementi -->
    <div id="virtual-cursor">
        <div id="cursor-progress"></div>
    </div>
    <!-- Kamera videosi yashirin holda -->
    <video id="video" style="display:none"></video>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Ikonkalar (SVG)
        const Icons = {
            Star: () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#FFD700" stroke="#b45309" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Back: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
            CameraOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M21 21l-2-2m-3.28-3.28A6 6 0 0 1 12 21a6 6 0 0 1-6-6c0-.52.06-1.02.16-1.5"></path><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M3.34 3.34a2 2 0 0 0-1.34 1.66V19a2 2 0 0 0 2 2h16c.52 0 1.02-.06 1.5-.16"></path><path d="M15 5h4a2 2 0 0 1 2 2v4"></path><path d="M9 5H7L5 2h6l2 3z"></path></svg>
        };

        // Konfetti effekti
        const fireConfetti = () => {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            for (let i = 0; i < 30; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti');
                el.style.left = Math.random() * 100 + 'vw';
                el.style.top = '-10px';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            }
        };

        // --- WEB KAMERA BOSHQARUVI KOMPONENTI ---
        const WebcamController = ({ onToggle, isEnabled }) => {
            const [status, setStatus] = useState('Kamerani yoqish');
            const [model, setModel] = useState(null);
            const videoRef = useRef(null);
            const requestRef = useRef(null);
            
            // "Dwell Click" (Ushlab turib bosish) o'zgaruvchilari
            const hoverTimer = useRef(0);
            const hoveredElement = useRef(null);
            const HOVER_THRESHOLD = 40; // Taxminan 1-1.5 soniya (har bir kadrda +1)

            const modelParams = {
                flipHorizontal: true,   // Ko'zgu effekti
                maxNumBoxes: 1,         // Faqat bitta qo'lni kuzatish
                iouThreshold: 0.5,
                scoreThreshold: 0.6,
            };

            useEffect(() => {
                videoRef.current = document.getElementById('video');
                
                if (isEnabled) {
                    startVideo();
                } else {
                    stopVideo();
                }

                return () => stopVideo();
            }, [isEnabled]);

            const startVideo = () => {
                setStatus('Model yuklanmoqda...');
                handTrack.load(modelParams).then(lModel => {
                    setModel(lModel);
                    setStatus('Kamera ishga tushmoqda...');
                    handTrack.startVideo(videoRef.current).then(status => {
                        if (status) {
                            setStatus('Faol');
                            document.getElementById('virtual-cursor').style.display = 'block';
                            runDetection(lModel);
                        } else {
                            setStatus('Iltimos, kamera ruxsatini bering');
                        }
                    });
                });
            };

            const stopVideo = () => {
                if (model) {
                    model.dispose();
                    handTrack.stopVideo(videoRef.current);
                }
                setModel(null);
                setStatus('Kamerani yoqish');
                document.getElementById('virtual-cursor').style.display = 'none';
                if (requestRef.current) cancelAnimationFrame(requestRef.current);
            };

            const runDetection = (lModel) => {
                lModel.detect(videoRef.current).then(predictions => {
                    if (predictions.length > 0) {
                        // Eng ishonchli qo'lni olamiz
                        const hand = predictions[0];
                        const bbox = hand.bbox; // [x, y, width, height]
                        
                        // Koordinatalarni hisoblash
                        const x = bbox[0] + bbox[2] / 2;
                        const y = bbox[1] + bbox[3] / 2;

                        // Ekranga moslash (Scale)
                        const videoWidth = videoRef.current.width || 640;
                        const videoHeight = videoRef.current.height || 480;
                        
                        const screenX = (x / videoWidth) * window.innerWidth;
                        const screenY = (y / videoHeight) * window.innerHeight;

                        updateCursor(screenX, screenY);
                    }
                    requestRef.current = requestAnimationFrame(() => runDetection(lModel));
                });
            };

            const updateCursor = (x, y) => {
                const cursor = document.getElementById('virtual-cursor');
                const progress = document.getElementById('cursor-progress');
                
                cursor.style.left = `${x}px`;
                cursor.style.top = `${y}px`;

                // Qaysi element ustida turibdi?
                // Kursorni vaqtinchalik yashiramiz, shunda u elementni to'sib qo'ymaydi
                cursor.style.display = 'none'; 
                let elem = document.elementFromPoint(x, y);
                cursor.style.display = 'block';

                // Interaktiv elementni topish (button yoki uning ichidagilar)
                let interactiveElem = null;
                if (elem) {
                    interactiveElem = elem.closest('button') || elem.closest('.interactive-target');
                }

                if (interactiveElem) {
                    // Agar o'sha element ustida tursa
                    if (hoveredElement.current === interactiveElem) {
                        hoverTimer.current++;
                        
                        // Progress vizualizatsiyasi
                        const percent = Math.min((hoverTimer.current / HOVER_THRESHOLD) * 360, 360);
                        progress.style.display = 'block';
                        progress.style.transform = `rotate(${percent}deg)`;
                        progress.style.borderTopColor = `hsl(${percent}, 100%, 50%)`;

                        // Bosish vaqti keldimi?
                        if (hoverTimer.current > HOVER_THRESHOLD) {
                            interactiveElem.click();
                            
                            // Bosilgandan keyin reset
                            hoverTimer.current = 0;
                            hoveredElement.current = null; // Qayta bosmasligi uchun
                            
                            // Vizual effekt (bosildi)
                            cursor.style.backgroundColor = 'rgba(0, 255, 0, 0.7)';
                            setTimeout(() => cursor.style.backgroundColor = 'rgba(255, 0, 0, 0.5)', 300);
                        }
                    } else {
                        // Yangi elementga o'tdi
                        hoveredElement.current = interactiveElem;
                        hoverTimer.current = 0;
                        
                        // Oldingi elementdan hover klassini olib tashlash
                        document.querySelectorAll('.hover-active').forEach(el => el.classList.remove('hover-active'));
                        interactiveElem.classList.add('hover-active');
                    }
                } else {
                    // Bo'sh joyda
                    hoveredElement.current = null;
                    hoverTimer.current = 0;
                    progress.style.display = 'none';
                    document.querySelectorAll('.hover-active').forEach(el => el.classList.remove('hover-active'));
                }
            };

            return null; // UI render qilmaydi, faqat logika
        };


        // --- O'YIN KOMPONENTLARI (O'zgarmagan, faqat classlar interactive uchun qo'shildi) ---

        // 1. Ranglarni topish o'yini
        const ColorsGame = ({ onFinish }) => {
            const levels = [
                { target: 'Qizil', colorCode: 'bg-red-500', options: ['bg-red-500', 'bg-blue-500', 'bg-green-500'] },
                { target: 'Yashil', colorCode: 'bg-green-500', options: ['bg-yellow-500', 'bg-green-500', 'bg-purple-500'] },
                { target: "Ko'k", colorCode: 'bg-blue-500', options: ['bg-blue-500', 'bg-orange-500', 'bg-red-500'] },
                { target: "Sariq", colorCode: 'bg-yellow-400', options: ['bg-purple-500', 'bg-gray-500', 'bg-yellow-400'] }
            ];
            const [currentLevel, setCurrentLevel] = useState(0);

            const handleChoice = (color) => {
                if (color === levels[currentLevel].colorCode) {
                    fireConfetti();
                    if (currentLevel < levels.length - 1) {
                        setTimeout(() => setCurrentLevel(currentLevel + 1), 1000);
                    } else {
                        setTimeout(() => onFinish(levels.length), 1000);
                    }
                }
            };

            const level = levels[currentLevel];

            return (
                <div className="flex flex-col items-center justify-center h-full p-4">
                    <h2 className="text-3xl font-bold mb-8 text-gray-700 text-center animate-pulse">
                        "{level.target}" rang qayerda?
                    </h2>
                    <div id="options-container" className="flex flex-wrap justify-center gap-6">
                        {level.options.map((color, idx) => (
                            <button
                                key={idx}
                                onClick={() => handleChoice(color)}
                                className={`w-32 h-32 rounded-full shadow-xl border-4 border-white transform transition-all ${color} game-card interactive-target`}
                            ></button>
                        ))}
                    </div>
                     <div className="mt-10 text-xl text-gray-500">
                        Kameraga qarang va qo'lingiz bilan to'g'ri rangni tanlang!
                    </div>
                </div>
            );
        };

        // 2. Sanash o'yini
        const MathGame = ({ onFinish }) => {
            const generateQuestion = () => {
                const count = Math.floor(Math.random() * 5) + 1; 
                const item = ['üçé', 'üçå', 'üê±', 'üöó', '‚≠ê'][Math.floor(Math.random() * 5)];
                let opts = new Set([count]);
                while(opts.size < 3) {
                    opts.add(Math.floor(Math.random() * 9) + 1);
                }
                return { count, item, options: Array.from(opts).sort(() => Math.random() - 0.5) };
            };

            const [question, setQuestion] = useState(generateQuestion());
            const [score, setScore] = useState(0);

            const handleAnswer = (num) => {
                if (num === question.count) {
                    fireConfetti();
                    if (score < 4) {
                        setScore(score + 1);
                        setTimeout(() => setQuestion(generateQuestion()), 800);
                    } else {
                        onFinish(5);
                    }
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full p-4">
                    <h2 className="text-2xl font-bold mb-4 text-gray-700">Nechta narsa bor?</h2>
                    
                    <div className="bg-white p-6 rounded-3xl shadow-lg mb-8 min-w-[300px] flex flex-wrap justify-center gap-4 min-h-[150px] items-center">
                        {Array.from({ length: question.count }).map((_, i) => (
                            <span key={i} className="text-5xl animate-bounce" style={{animationDelay: `${i*0.1}s`}}>
                                {question.item}
                            </span>
                        ))}
                    </div>

                    <div className="flex gap-4">
                        {question.options.map((num) => (
                            <button
                                key={num}
                                onClick={() => handleAnswer(num)}
                                className="w-24 h-24 bg-blue-500 hover:bg-blue-600 text-white text-5xl font-bold rounded-2xl shadow-lg transform transition-transform game-card interactive-target"
                            >
                                {num}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // 3. Shakllar o'yini
        const ShapesGame = ({ onFinish }) => {
             const shapes = [
                { name: 'Kvadrat', type: 'square', css: 'w-24 h-24 bg-red-500 rounded-none' },
                { name: 'Doira', type: 'circle', css: 'w-24 h-24 bg-blue-500 rounded-full' },
                { name: 'Uchburchak', type: 'triangle', css: 'w-0 h-0 border-l-[50px] border-l-transparent border-r-[50px] border-r-transparent border-b-[100px] border-b-green-500' }
            ];
            
            const [currentRound, setCurrentRound] = useState(0);
            const [targetShape, setTargetShape] = useState(shapes[0]);

            useEffect(() => {
                setTargetShape(shapes[Math.floor(Math.random() * shapes.length)]);
            }, [currentRound]);

            const handleShapeClick = (shape) => {
                if (shape.type === targetShape.type) {
                    fireConfetti();
                    if (currentRound < 4) {
                        setTimeout(() => setCurrentRound(currentRound + 1), 800);
                    } else {
                        onFinish(5);
                    }
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full p-4">
                     <h2 className="text-3xl font-bold mb-8 text-gray-700 text-center">
                        <span className="text-purple-600">{targetShape.name}</span>ni top!
                    </h2>

                    <div className="flex flex-wrap justify-center gap-12 items-center">
                        {shapes.map((shape, idx) => (
                            <button key={idx} onClick={() => handleShapeClick(shape)} className="game-card interactive-target p-6 bg-white rounded-xl shadow-md hover:bg-gray-50">
                                <div className={`${shape.css}`}></div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- ASOSIY ILOVA ---
        const App = () => {
            const [view, setView] = useState('menu'); 
            const [totalStars, setTotalStars] = useState(0);
            const [isCamEnabled, setIsCamEnabled] = useState(false);

            const handleGameFinish = (starsEarned) => {
                setTotalStars(prev => prev + starsEarned);
                setView('win');
            };

            const toggleCamera = () => {
                setIsCamEnabled(!isCamEnabled);
            };

            const renderMenu = () => (
                <div className="flex flex-col items-center w-full max-w-md mx-auto p-4 z-10 relative">
                    <header className="flex justify-between items-center w-full mb-8 bg-white p-4 rounded-2xl shadow-sm">
                        <h1 className="text-2xl font-bold text-pink-500 flex items-center gap-2">
                             Smart Bolajon üë∂
                        </h1>
                        <div className="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-full border border-yellow-300">
                            <Icons.Star />
                            <span className="text-xl font-bold text-yellow-600">{totalStars}</span>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 gap-6 w-full">
                        <button 
                            onClick={() => setView('colors')}
                            className="game-card interactive-target bg-gradient-to-r from-pink-400 to-rose-400 text-white p-6 rounded-3xl shadow-lg flex items-center gap-4 hover:shadow-xl"
                        >
                            <span className="text-5xl">üé®</span>
                            <div className="text-left">
                                <h3 className="text-2xl font-bold">Ranglar</h3>
                                <p className="opacity-90">Ranglarni ajratamiz</p>
                            </div>
                        </button>

                        <button 
                            onClick={() => setView('math')}
                            className="game-card interactive-target bg-gradient-to-r from-blue-400 to-cyan-400 text-white p-6 rounded-3xl shadow-lg flex items-center gap-4 hover:shadow-xl"
                        >
                            <span className="text-5xl">üî¢</span>
                            <div className="text-left">
                                <h3 className="text-2xl font-bold">Sanash</h3>
                                <p className="opacity-90">1, 2, 3 - sanaymiz!</p>
                            </div>
                        </button>

                        <button 
                            onClick={() => setView('shapes')}
                            className="game-card interactive-target bg-gradient-to-r from-purple-400 to-indigo-400 text-white p-6 rounded-3xl shadow-lg flex items-center gap-4 hover:shadow-xl"
                        >
                            <span className="text-5xl">üî∫</span>
                            <div className="text-left">
                                <h3 className="text-2xl font-bold">Shakllar</h3>
                                <p className="opacity-90">Doira va kvadrat</p>
                            </div>
                        </button>
                    </div>
                </div>
            );

            const renderWinScreen = () => (
                <div className="flex flex-col items-center justify-center h-full text-center p-6 z-10 relative">
                    <div className="text-6xl mb-4 animate-bounce">üèÜ</div>
                    <h2 className="text-4xl font-bold text-green-500 mb-2">Barakalla!</h2>
                    <p className="text-gray-600 text-xl mb-8">Sen uddalading!</p>
                    <button 
                        onClick={() => setView('menu')}
                        className="bg-yellow-400 hover:bg-yellow-500 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all interactive-target"
                    >
                        Davom etish
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen bg-blue-50 flex flex-col relative overflow-hidden">
                    
                    <WebcamController isEnabled={isCamEnabled} />

                    {/* Kamera tugmasi */}
                    <div className="absolute top-4 right-4 z-50">
                        <button 
                            onClick={toggleCamera}
                            className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold shadow-lg transition-all ${isCamEnabled ? 'bg-red-500 text-white' : 'bg-white text-gray-700'}`}
                        >
                            {isCamEnabled ? <Icons.CameraOff /> : <Icons.Camera />}
                            {isCamEnabled ? "Kamerani o'chirish" : "Sehrli qo'l"}
                        </button>
                    </div>

                    {view !== 'menu' && view !== 'win' && (
                        <div className="p-4 flex justify-between items-center max-w-md mx-auto w-full z-10 relative">
                            <button onClick={() => setView('menu')} className="bg-white p-2 rounded-xl shadow text-gray-600 hover:bg-gray-100 interactive-target">
                                <Icons.Back />
                            </button>
                        </div>
                    )}

                    <main className="flex-grow z-10 relative">
                        {view === 'menu' && renderMenu()}
                        {view === 'colors' && <ColorsGame onFinish={handleGameFinish} />}
                        {view === 'math' && <MathGame onFinish={handleGameFinish} />}
                        {view === 'shapes' && <ShapesGame onFinish={handleGameFinish} />}
                        {view === 'win' && renderWinScreen()}
                    </main>

                    {/* Fon bezaklari (dekoratsiya) */}
                    <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20 z-0">
                         <div className="absolute top-10 left-10 text-6xl rotate-12">üéà</div>
                         <div className="absolute bottom-10 right-10 text-6xl -rotate-12">üß∏</div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>